# ============================================================================
# EJLOG WMS - Security Headers Configuration
# For Nginx, Apache, or Express.js server
# ============================================================================

# ============================================================================
# NGINX CONFIGURATION
# ============================================================================

# Add these headers to your nginx.conf or site configuration file
# Inside the 'server' or 'location' block

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Prevent clickjacking attacks
add_header X-Frame-Options "DENY" always;

# Enable XSS protection (legacy, but still useful)
add_header X-XSS-Protection "1; mode=block" always;

# Control referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (replaces Feature-Policy)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# Strict Transport Security (HTTPS only)
# Uncomment after HTTPS is configured
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Content Security Policy
add_header Content-Security-Policy "
  default-src 'self';
  script-src 'self' 'unsafe-inline' 'unsafe-eval' https://fonts.googleapis.com;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src 'self' https://fonts.gstatic.com data:;
  img-src 'self' data: blob: https:;
  connect-src 'self' http://localhost:3079 https://fonts.googleapis.com https://fonts.gstatic.com;
  frame-ancestors 'none';
  base-uri 'self';
  form-action 'self';
" always;


# ============================================================================
# APACHE CONFIGURATION (.htaccess or httpd.conf)
# ============================================================================

# <IfModule mod_headers.c>
#   # Prevent MIME type sniffing
#   Header always set X-Content-Type-Options "nosniff"
#
#   # Prevent clickjacking
#   Header always set X-Frame-Options "DENY"
#
#   # XSS Protection
#   Header always set X-XSS-Protection "1; mode=block"
#
#   # Referrer Policy
#   Header always set Referrer-Policy "strict-origin-when-cross-origin"
#
#   # Permissions Policy
#   Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
#
#   # HSTS (uncomment after HTTPS setup)
#   # Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#
#   # Content Security Policy
#   Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: blob: https:; connect-src 'self' http://localhost:3079; frame-ancestors 'none';"
# </IfModule>


# ============================================================================
# EXPRESS.JS CONFIGURATION
# ============================================================================

# Install helmet middleware:
# npm install helmet

# In your server.js or app.js:

/*
const express = require('express');
const helmet = require('helmet');

const app = express();

// Basic helmet configuration
app.use(helmet());

// Custom CSP configuration
app.use(
  helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'", "https://fonts.googleapis.com"],
      styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
      fontSrc: ["'self'", "https://fonts.gstatic.com", "data:"],
      imgSrc: ["'self'", "data:", "blob:", "https:"],
      connectSrc: ["'self'", "http://localhost:3079", "https://fonts.googleapis.com"],
      frameAncestors: ["'none'"],
      baseUri: ["'self'"],
      formAction: ["'self'"],
    },
  })
);

// HSTS (uncomment after HTTPS setup)
// app.use(
//   helmet.hsts({
//     maxAge: 31536000,
//     includeSubDomains: true,
//     preload: true,
//   })
// );

app.listen(3000, () => {
  console.log('Server running with security headers');
});
*/


# ============================================================================
# SECURITY HEADERS EXPLANATION
# ============================================================================

# X-Content-Type-Options: nosniff
#   Prevents browsers from MIME-sniffing a response away from the declared content-type
#   Protection against: MIME type confusion attacks

# X-Frame-Options: DENY
#   Prevents the page from being displayed in a frame/iframe
#   Protection against: Clickjacking attacks
#   Alternatives: SAMEORIGIN (allow same-origin framing)

# X-XSS-Protection: 1; mode=block
#   Enables XSS filter built into modern browsers
#   Protection against: Cross-Site Scripting (XSS) attacks
#   Note: Legacy header, CSP is more effective

# Referrer-Policy: strict-origin-when-cross-origin
#   Controls how much referrer information is sent
#   - Same origin: full URL
#   - Cross origin: only origin (no path)
#   Protection against: Information leakage

# Permissions-Policy
#   Controls which browser features can be used
#   Protection against: Unauthorized feature access

# Strict-Transport-Security (HSTS)
#   Forces browsers to use HTTPS
#   max-age: How long to remember (1 year = 31536000)
#   includeSubDomains: Apply to all subdomains
#   preload: Submit to HSTS preload list
#   Protection against: Man-in-the-middle attacks
#   WARNING: Only enable after HTTPS is working!

# Content-Security-Policy (CSP)
#   Controls which resources can be loaded
#   - default-src: Fallback for other directives
#   - script-src: JavaScript sources
#   - style-src: CSS sources
#   - font-src: Font sources
#   - img-src: Image sources
#   - connect-src: AJAX, WebSocket sources
#   - frame-ancestors: Who can embed this page
#   Protection against: XSS, data injection, clickjacking


# ============================================================================
# PRODUCTION CHECKLIST
# ============================================================================

# Before deploying to production:
#
# 1. [ ] Configure HTTPS/TLS certificate
# 2. [ ] Enable HSTS header (after HTTPS works)
# 3. [ ] Update CSP connect-src to production API URL
# 4. [ ] Remove 'unsafe-inline' and 'unsafe-eval' if possible
# 5. [ ] Test all security headers with:
#        - https://securityheaders.com
#        - https://observatory.mozilla.org
# 6. [ ] Enable CSP reporting (report-uri or report-to)
# 7. [ ] Monitor CSP violations in production
# 8. [ ] Review and update security headers quarterly


# ============================================================================
# CSP REPORTING (OPTIONAL)
# ============================================================================

# Add reporting endpoint to CSP:
# report-uri /api/csp-report;
# report-to csp-endpoint;

# Example report handler (Express.js):
/*
app.post('/api/csp-report', express.json({ type: 'application/csp-report' }), (req, res) => {
  console.log('CSP Violation:', req.body);
  // Log to monitoring service (Sentry, DataDog, etc.)
  res.status(204).end();
});
*/


# ============================================================================
# TESTING SECURITY HEADERS
# ============================================================================

# Test with curl:
# curl -I https://your-domain.com

# Test with online tools:
# - https://securityheaders.com
# - https://observatory.mozilla.org
# - https://csp-evaluator.withgoogle.com (CSP validator)

# Expected results:
# - A+ rating on securityheaders.com
# - A rating on observatory.mozilla.org
# - No critical CSP warnings on csp-evaluator


# ============================================================================
# NOTES
# ============================================================================

# 'unsafe-inline' and 'unsafe-eval' in CSP:
#   - Currently needed for Vite dev server and some React features
#   - For production, use nonces or hashes instead
#   - Example with nonces: script-src 'self' 'nonce-{RANDOM_VALUE}'

# Local API (http://localhost:3079):
#   - Change to production API URL before deploying
#   - Use environment variable: connect-src 'self' ${API_URL}

# Google Fonts:
#   - Self-host fonts in production for better privacy
#   - Remove fonts.googleapis.com from CSP if self-hosted

